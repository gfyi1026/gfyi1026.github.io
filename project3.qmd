---
title: "Simulation Study"
description: |
  Analysis of mtcars MPG (Manual vs Automatic)
author: "Guy Fuchs"
date: today
format: html
execute:
  warning: false
  message: false
---

> Dataset page: [R Datasets Package](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/mtcars.html)  
> Original source: The data was originally published in the 1974 Motor Trend US Magazine and later referenced in Henderson and Velleman (1981), *Building Multiple Regression Models Interactively*, *Biometrics*.


```{r}
#| label: setup
#| code-fold: true
set.seed(47)
library(tidyverse)
library(purrr)
```

# Outline 
I will compare MPG between manual and automatic cars in the built in `mtcars` dataset. The data comes from the 1974 *Motor Trend* US magazine, so I treat the 32 cars in the dataset as a sample from a broader population of early 1970s cars similar to those reviewed by Motor Trend, not from modern cars, and so any inferences and conclusions made will be about that population, not to modern vehicles. This will be interesting to analyze as MPG is a practical measure of efficiency, so this simulation will help us understand if the relationship could arise by chance with no true relationship. 

My goal is to test whether manual transmissions in that 1970s era population tend to have higher fuel economy than automatics. To make that precise, I will use the following hypotheses:

- Null hypothesis (H₀): In the population of early 1970s cars, manual transmissions do not have higher mean MPG than automatics. Under H₀, the true difference in mean MPG (Manual − Automatic) is zero or negative.  
- Alternative hypothesis (H₁): In that same population, manual transmissions have higher mean MPG than automatics, so the true difference in mean MPG (Manual − Automatic) is positive.

This test will compare two varaibles from the dataset, the first being mpg, a numerical value representing miles per gallon for each car. The second is am, indicating transmission type. In the raw dataset, 0 means automatic and 1 means manual, so I convert it into a factor with clearer labels. Therefore, these two variables form the foundation of both the observed comparison and the simulated null distribution.

To test these hypotheses, I will use a permutation test. I compute the observed difference in mean MPG between manual and automatic cars, then simulate a world where transmission type has no relationship with MPG by repeatedly shuffling the transmission labels and recomputing the difference. This builds a null distribution for the statistic (Manual − Automatic mean MPG) that I can compare to the observed value to obtain a one sided p value.

```{r}
cars <- as_tibble(mtcars, rownames = "model") |>
  mutate(am = factor(am, c(0,1), labels = c("Automatic", "Manual")))
cars |>
  head(n=5)
```

```{r}
#| label: fig-mtcars-mpg-transmission
#| fig-alt: "Boxplot comparing miles per gallon (y-axis) for cars with automatic versus manual transmissions (x-axis) in the mtcars dataset. Manual cars show a higher median MPG and a wider spread of values, while automatic cars cluster lower with less variation. Individual data points are jittered over each box."

ggplot(cars, aes(x = am, y = mpg, fill = am)) +
  geom_boxplot(width = 0.55, alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.1) +
  labs(
    title = "Fuel economy (MPG) by transmission",
    x = "Transmission", y = "MPG", fill = "Transmission"
    ) +
  theme_minimal()

```
This boxplot compares fuel economy, MPG, between cars with automatic and manual transmissions in the "mtcars" dataset. In the plot, every dot represents one car, and from the boxplot we can see that manual cars generally have higher MPG than automatic cars, with both a higher median and a wider spread of values. Thus, this suggests that manual transmissions may be more fuel-efficent on average in this dataset.

To visualize the original data:
```{r}
cars |>
  group_by(am) |>
  summarise(
    n = n(),
    mean_mpg = mean(mpg),
    median_mpg = median(mpg)
  )

```

Now, for the simulation part:

```{r}
mean_diff <- function(data){
  manual_mpg <- mean(data$mpg[data$am == "Manual"])
  auto_mpg   <- mean(data$mpg[data$am == "Automatic"])
  return(manual_mpg - auto_mpg)
}

perm_once <- function(data){
  data_perm <- data
  data_perm$am <- sample(data_perm$am)
  mean_diff(data_perm)
}

```


Observed difference in means:
```{r}
obs <- mean_diff(cars)
obs
```

Null distribution under "no relationship" and one-side p-value:
```{r}
B <- 5000
null_vals <- map_dbl(1:B, function(i) perm_once(cars))
p_value <- mean(null_vals >= obs)
p_value_formatted <- format(p_value, scientific = FALSE, digits = 4)

tibble(
  observed_diff = obs,
  p_value_one_sided = p_value_formatted,
  permutations = B
)
```
The p_value_one_sided is actually equal to 0.0004, but R rounds it down to 0.

Description of the simulation:

The simulation works by repeatedly shuffling the transmission labels to represent an environment where there is no true relationship between transmission type and fuel economy (the null hypothesis). 
- The function mean_diff() calculates the difference in average MPG between manual and automatic cars for any given dataset. 
- The function perm_once() performs one permutation by randomly reassigning transmission labels and then calling mean_diff() to get a new difference value. 
- I used map_dbl() to repeat this process 5,000 times, because it provides a fast way to apply the same function many times and store the numeric results in a single vector. This created a simulated null distribution of MPG differences that we can compare the observed difference against to determine how different it is the under the null model.



Plotting the null distribution:
```{r}
#| label: fig-mtcars-permutation-null
#| fig-alt: "Histogram showing the permutation-based null distribution of the difference in mean MPG between manual and automatic cars, where the x-axis is the null statistic (manual - automatic mean MPG) and the y-axis is the count. The distribution is centered near zero with a wide spread from about negative six to positive six. A dashed vertical line marks the observed difference, which lies far to the right of most simulated values."

tibble(null = null_vals) |>
  ggplot(aes(x = null)) +
  geom_histogram(bins = 40, alpha = 0.85) +
  geom_vline(xintercept = obs, linetype = "dashed") +
  labs(
    title = "Permutation null for MPG difference (Manual − Automatic)",
    x = "Null statistic (Manual − Automatic mean MPG)",
    y = "Count"
  ) +
  theme_minimal()
```
This histogram shows the null distribution of differences in mean MPG between manual and automatic cars, created by randomly shuffling the transmission labels 5,000 times. The x-axis represents the simulated differences under the null hypothesis of no relationship between transmission and MPG, with the y-axis showing how often each difference occurred. The dashed vertical line marks the observed difference from the real data, which was about 7.24 MPG. This observed value lies far to the right of all simulated values, and thus suggests that differences of this magnitude almost never appear in a world where transmission type has no relationship to MPG among early 1970s cars. So, this visual is consistent with the small one sided p value and supports the idea that the observed difference is unlikely to be due to random variation alone.

# To conclude:

In this analysis, I conducted a permutation test to determine whether cars with manual transmission have higher fuel economy, MPG, than cars with automatic transmission in the "mtcars" dataset. I computed the observed difference in mean MPG and then simulated the null hypothesis by repeatedly shuffling transmission labels and recalculating the mean difference 5,000 times. The resulting null distribution was centered around 0, while the observed difference (7.24 MPG) was far outside this range, giving a p-value of 0.0004, which is less than 0.01. This indicated that it is highly unlikely the difference in MPG occurred by chance, providing very strong evidence against the null model, and ultimately that manual cars are more fuel-efficient on average. 

